(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,89198,e=>{"use strict";var a=e.i(43476),i=e.i(71645),t=e.i(18566),s=e.i(41741),l=e.i(66027),o=e.i(67881),c=e.i(70065),r=e.i(23750),n=e.i(10708),d=e.i(69035),m=e.i(62870),x=e.i(27612),u=e.i(7233),p=e.i(71689),h=e.i(3281),g=e.i(56909),j=e.i(21557),_=e.i(74886),f=e.i(88699),b=e.i(78583),v=e.i(63059),N=e.i(64659),C=e.i(47163),y=e.i(25959),S=e.i(43531),w=e.i(44523),I=e.i(75254);let T=(0,I.default)("user",[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]]);var z=e.i(53751),A=e.i(59377);function E({value:e,onChange:t,clientes:s=[],disabled:l}){let[c,r]=i.useState(!1),n=s?.find(a=>a.id_cliente===e);return(0,a.jsxs)(A.Popover,{open:c,onOpenChange:r,children:[(0,a.jsx)(A.PopoverTrigger,{asChild:!0,children:(0,a.jsxs)(o.Button,{variant:"outline",role:"combobox","aria-expanded":c,disabled:l,className:(0,C.cn)("w-full justify-between pl-3 text-left font-normal",!e&&"text-muted-foreground"),children:[n?(0,a.jsxs)("span",{className:"flex items-center gap-2 truncate",children:[(0,a.jsx)(T,{className:"h-4 w-4 opacity-50"}),n.nombre_completo]}):"Seleccionar Cliente...",(0,a.jsx)(w.ChevronsUpDown,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),(0,a.jsx)(A.PopoverContent,{className:"w-[300px] p-0",align:"start",children:(0,a.jsxs)(z.Command,{children:[(0,a.jsx)(z.CommandInput,{placeholder:"Buscar cliente..."}),(0,a.jsxs)(z.CommandList,{children:[(0,a.jsx)(z.CommandEmpty,{children:"No se encontró cliente."}),(0,a.jsx)(z.CommandGroup,{children:s?.map(i=>(0,a.jsxs)(z.CommandItem,{value:i.nombre_completo,onSelect:()=>{t(i.id_cliente),r(!1)},className:"cursor-pointer",children:[(0,a.jsx)(S.Check,{className:(0,C.cn)("mr-2 h-4 w-4",e===i.id_cliente?"opacity-100":"opacity-0")}),(0,a.jsxs)("div",{className:"flex flex-col",children:[(0,a.jsx)("span",{children:i.nombre_completo}),i.nro_doc&&(0,a.jsxs)("span",{className:"text-xs text-muted-foreground",children:["ID: ",i.nro_doc]})]})]},i.id_cliente))})]})]})})]})}var k=e.i(84765),D=e.i(54616),V=e.i(12598),F=e.i(30374),R=e.i(31278),P=e.i(78894);let O=(0,I.default)("wrench",[["path",{d:"M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.106-3.105c.32-.322.863-.22.983.218a6 6 0 0 1-8.259 7.057l-7.91 7.91a1 1 0 0 1-2.999-3l7.91-7.91a6 6 0 0 1 7.057-8.259c.438.12.54.662.219.984z",key:"1ngwbx"}]]);var L=e.i(71287),q=e.i(74117),B=e.i(47627);function M({idLinea:e,isOpen:t,onOpenChange:c}){let n=(0,V.useQueryClient)(),{toast:d}=(0,q.useToast)(),[p,h]=(0,i.useState)([]),[g,j]=(0,i.useState)(!1),{data:_,isLoading:f}=(0,l.useQuery)({queryKey:["despiece",e],queryFn:()=>s.cotizacionesApi.getDesgloseMateriales(e),enabled:t});(0,i.useEffect)(()=>{_&&!g&&h(JSON.parse(JSON.stringify(_)))},[_,t]);let b=(0,D.useMutation)({mutationFn:async a=>{_?.map(e=>e.id_desglose);let i=new Set(a.map(e=>e.id_desglose).filter(Boolean));for(let e of _?.filter(e=>!i.has(e.id_desglose))||[])await s.cotizacionesApi.deleteDesgloseItem(e.id_desglose);for(let i of a)if(i.id_desglose)await s.cotizacionesApi.updateDesgloseItem(i.id_desglose,{nombre_componente:i.nombre_componente,sku_real:i.sku_real,cantidad_calculada:i.cantidad_calculada,costo_total_item:i.costo_total_item,tipo_componente:i.tipo_componente,medida_corte_mm:i.medida_corte_mm,detalle_formula:i.detalle_formula});else{let a={...i};delete a.id_desglose,await s.cotizacionesApi.addDesgloseItem({...a,id_linea_cot:e})}await s.cotizacionesApi.setManualFlag(e,!0)},onSuccess:()=>{n.invalidateQueries({queryKey:["despiece",e]}),n.invalidateQueries({queryKey:["cotizaciones"]}),d({title:"Ingeniería actualizada correctamente"}),c(!1),j(!1)},onError:e=>{d({title:"Error al guardar ingeniería",description:e.message,variant:"destructive"})}}),v=(e,a,i)=>{let t=[...p];t[e]={...t[e],[a]:i},h(t),j(!0)};return(0,a.jsx)(F.Dialog,{open:t,onOpenChange:c,children:(0,a.jsxs)(F.DialogContent,{className:"max-w-[95vw] w-full h-[95vh] flex flex-col p-0 gap-0 sm:max-w-[95vw]",children:[(0,a.jsxs)(F.DialogHeader,{className:"px-6 py-4 border-b",children:[(0,a.jsxs)(F.DialogTitle,{className:"flex items-center gap-2",children:[(0,a.jsx)(O,{className:"h-5 w-5 text-orange-600"}),"Edición Manual de Ingeniería"]}),(0,a.jsxs)(F.DialogDescription,{className:"flex items-center gap-2 text-orange-700 bg-orange-50 p-2 rounded border border-orange-200",children:[(0,a.jsx)(P.AlertTriangle,{className:"h-4 w-4 shrink-0"}),"Advertencia: Al editar manualmente, este ítem dejará de calcularse automáticamente. Si cambias las medidas (Ancho/Alto) después, se te pedirá confirmación para sobreescribir estos cambios."]})]}),(0,a.jsx)("div",{className:"flex-1 overflow-auto p-6 flex flex-col gap-4",children:(0,a.jsx)("div",{className:"flex-1 border rounded-md overflow-auto relative",children:(0,a.jsxs)(B.Table,{children:[(0,a.jsx)(B.TableHeader,{children:(0,a.jsxs)(B.TableRow,{children:[(0,a.jsx)(B.TableHead,{className:"w-[100px]",children:"Tipo"}),(0,a.jsx)(B.TableHead,{className:"w-[160px]",children:"SKU"}),(0,a.jsx)(B.TableHead,{children:"Nombre / Descripción"}),(0,a.jsx)(B.TableHead,{className:"w-[140px]",children:"Fórmula"}),(0,a.jsx)(B.TableHead,{className:"w-[100px] text-right",children:"Medida"}),(0,a.jsx)(B.TableHead,{className:"w-[80px] text-right",children:"Cant."}),(0,a.jsx)(B.TableHead,{className:"w-[100px] text-right",children:"Costo Unit."}),(0,a.jsx)(B.TableHead,{className:"w-[100px] text-right",children:"Total"}),(0,a.jsx)(B.TableHead,{className:"w-[50px]"})]})}),(0,a.jsx)(B.TableBody,{children:f?(0,a.jsx)(B.TableRow,{children:(0,a.jsx)(B.TableCell,{colSpan:9,className:"text-center h-24",children:(0,a.jsx)(R.Loader2,{className:"h-6 w-6 animate-spin mx-auto"})})}):p.map((e,i)=>(0,a.jsxs)(B.TableRow,{children:[(0,a.jsx)(B.TableCell,{children:(0,a.jsxs)(m.Select,{value:e.tipo_componente,onValueChange:e=>v(i,"tipo_componente",e),children:[(0,a.jsx)(m.SelectTrigger,{className:"h-8",children:(0,a.jsx)(m.SelectValue,{})}),(0,a.jsxs)(m.SelectContent,{children:[(0,a.jsx)(m.SelectItem,{value:"Perfil",children:"Perfil"}),(0,a.jsx)(m.SelectItem,{value:"Accesorio",children:"Accesorio"}),(0,a.jsx)(m.SelectItem,{value:"Vidrio",children:"Vidrio"}),(0,a.jsx)(m.SelectItem,{value:"Servicio",children:"Servicio"}),(0,a.jsx)(m.SelectItem,{value:"Otro",children:"Otro"})]})]})}),(0,a.jsx)(B.TableCell,{children:(0,a.jsx)(L.CatalogSkuSelector,{value:e.sku_real||"",onChange:(a,t)=>{let s={sku_real:a};t&&(s.nombre_componente=t.nombre_completo,s.costo_total_item=t.costo_mercado_unit||0,a.startsWith("AL-")?s.tipo_componente="Perfil":a.startsWith("GEN-")?s.tipo_componente="Accesorio":a.startsWith("VID-")&&(s.tipo_componente="Vidrio"),"Perfil"===s.tipo_componente&&e.detalle_formula);let l=[...p];l[i]={...l[i],...s},h(l),j(!0)}})}),(0,a.jsx)(B.TableCell,{children:(0,a.jsx)(r.Input,{value:e.nombre_componente||"",onChange:e=>v(i,"nombre_componente",e.target.value),className:"h-8"})}),(0,a.jsx)(B.TableCell,{children:(0,a.jsx)(r.Input,{value:e.detalle_formula||"",onChange:e=>v(i,"detalle_formula",e.target.value),className:"h-8 text-xs text-muted-foreground",placeholder:"Ej. Ancho - 50"})}),(0,a.jsx)(B.TableCell,{children:(0,a.jsx)(r.Input,{type:"number",value:e.medida_corte_mm||"",onChange:e=>v(i,"medida_corte_mm",parseFloat(e.target.value)),className:"h-8 text-right",placeholder:"mm"})}),(0,a.jsx)(B.TableCell,{children:(0,a.jsx)(r.Input,{type:"number",value:e.cantidad_calculada||0,onChange:e=>v(i,"cantidad_calculada",parseFloat(e.target.value)),className:"h-8 text-right",step:"0.01"})}),(0,a.jsx)(B.TableCell,{children:(0,a.jsx)(r.Input,{type:"number",value:e.costo_total_item||0,onChange:e=>v(i,"costo_total_item",parseFloat(e.target.value)),className:"h-8 text-right",step:"0.01"})}),(0,a.jsx)(B.TableCell,{className:"text-right font-medium",children:(0,C.formatCurrency)((e.costo_total_item||0)*(e.cantidad_calculada||1))}),(0,a.jsx)(B.TableCell,{children:(0,a.jsx)(o.Button,{variant:"ghost",size:"icon",onClick:()=>{let e;(e=[...p]).splice(i,1),h(e),j(!0)},children:(0,a.jsx)(x.Trash2,{className:"h-4 w-4 text-red-500"})})})]},i))})]})})}),(0,a.jsx)("div",{className:"px-6 py-2 border-t bg-white",children:(0,a.jsxs)(o.Button,{variant:"outline",size:"sm",onClick:()=>{h([...p,{id_desglose:"",nombre_componente:"Nuevo Componente",sku_real:"",tipo_componente:"Accesorio",cantidad_calculada:1,costo_total_item:0}]),j(!0)},className:"gap-2",children:[(0,a.jsx)(u.Plus,{className:"h-4 w-4"})," Agregar Material / Servicio"]})}),(0,a.jsxs)(F.DialogFooter,{className:"px-6 py-4 border-t bg-slate-50",children:[(0,a.jsx)(o.Button,{variant:"ghost",onClick:()=>c(!1),children:"Cancelar"}),(0,a.jsxs)(o.Button,{onClick:()=>{b.mutate(p)},disabled:b.isPending||!g,children:[b.isPending&&(0,a.jsx)(R.Loader2,{className:"mr-2 h-4 w-4 animate-spin"}),"Guardar Cambios Manuales"]})]})]})})}function H({idLinea:e}){let[t,o]=(0,i.useState)(!0),[c,r]=(0,i.useState)(!1),{data:n,isLoading:d}=(0,l.useQuery)({queryKey:["despiece",e],queryFn:()=>s.cotizacionesApi.getDesgloseMateriales(e),staleTime:3e5});if(d)return(0,a.jsx)("span",{className:"text-muted-foreground italic text-xs",children:"Cargando ingeniería..."});if(!n||0===n.length)return(0,a.jsx)("span",{className:"text-muted-foreground italic text-xs",children:"Sin despiece generado. Click en calculadora."});let m=n.filter(e=>"Perfil"===e.tipo_componente),x=n.filter(e=>"Perfil"!==e.tipo_componente),u=n.reduce((e,a)=>e+(Number(a.costo_total_item)||0),0);return(0,a.jsxs)("div",{className:`flex flex-col rounded-md border border-slate-100 transition-all ${t?"gap-2 p-2 bg-slate-50":"bg-transparent border-0"}`,children:[(0,a.jsx)(M,{idLinea:e,isOpen:c,onOpenChange:r}),(0,a.jsxs)("div",{className:`flex justify-between items-center p-1 rounded select-none ${!t&&"py-0 h-6"}`,children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 cursor-pointer hover:bg-slate-100 rounded p-1",onClick:()=>o(!t),title:t?"Minimizar":"Expandir detalles",children:[t?(0,a.jsx)(N.ChevronDown,{className:"h-4 w-4 text-slate-500"}):(0,a.jsx)(v.ChevronRight,{className:"h-4 w-4 text-slate-500"}),(0,a.jsx)("h4",{className:`font-bold text-xs ${t?"text-slate-700":"text-slate-500"}`,children:"Desglose de Materiales (Ingeniería)"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[t&&(0,a.jsxs)("button",{onClick:()=>r(!0),className:"text-xs text-blue-600 hover:text-blue-800 hover:bg-blue-50 px-2 py-0.5 rounded flex items-center gap-1 transition-colors",title:"Editar manualmente ingeniería",children:[(0,a.jsx)(k.Settings2,{className:"h-3 w-3"}),"Editar"]}),(0,a.jsxs)("span",{className:`text-xs font-bold px-2 py-0.5 rounded cursor-pointer ${t?"text-slate-900 bg-slate-200":"text-slate-600 bg-transparent"}`,onClick:()=>o(!t),children:[t&&"Costo Total: "," ",(0,C.formatCurrency)(u)]})]})]}),t&&(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-xs animate-in slide-in-from-top-2 duration-200 pl-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"font-semibold text-slate-600 block mb-1",children:"Perfiles de Aluminio:"}),(0,a.jsx)("ul",{className:"list-disc list-inside text-gray-600 space-y-0.5",children:m.map(e=>(0,a.jsxs)("li",{className:"flex justify-between gap-2",children:[(0,a.jsxs)("span",{children:[e.nombre_componente,(0,a.jsxs)("span",{className:"text-slate-500 ml-1",children:["(",Math.round(e.medida_corte_mm??0),"mm)"]})]}),(0,a.jsxs)("div",{className:"flex gap-2 text-right",children:[(0,a.jsx)("span",{className:"font-mono text-xs text-slate-400",children:e.sku_real}),(0,a.jsx)("span",{className:"font-medium min-w-[60px]",children:(0,C.formatCurrency)(Number(e.costo_total_item)||0)})]})]},e.id_desglose))})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"font-semibold text-slate-600 block mb-1",children:"Vidrios, Accesorios y Servicios:"}),(0,a.jsx)("ul",{className:"list-disc list-inside text-gray-600 space-y-0.5",children:x.map(e=>(0,a.jsxs)("li",{className:"flex justify-between gap-2",children:[(0,a.jsxs)("span",{children:[e.cantidad_calculada&&e.cantidad_calculada>0&&(0,a.jsxs)("span",{className:"font-bold text-slate-700 mr-1",children:[e.cantidad_calculada," x"]}),e.nombre_componente]}),(0,a.jsx)("span",{className:"font-medium",children:(0,C.formatCurrency)(Number(e.costo_total_item)||0)})]},e.id_desglose))})]})]})]})}var U=e.i(17931),$=e.i(27341),G=e.i(15788),K=e.i(9306);function Q({idCotizacion:e,onItemAdded:t,triggerButton:c,itemToEdit:d,open:x,onOpenChange:p}){let h,g,j,_,f,b,v=(0,K.useToastHelper)(),[N,C]=(0,i.useState)(!1),y=void 0!==x,S=y?x:N,w=e=>{y?p?.(e):C(e)},[I,T]=(0,i.useState)(!1),[z,A]=(0,i.useState)("producto"),{data:E}=(0,l.useQuery)({queryKey:["mstSistemas"],queryFn:s.cotizacionesApi.getSistemas}),{data:k}=(0,l.useQuery)({queryKey:[" mstRecetasIDs"],queryFn:s.cotizacionesApi.getRecetasIDs}),{data:D}=(0,l.useQuery)({queryKey:["catVidrios"],queryFn:s.cotizacionesApi.getVidrios}),{data:V}=(0,l.useQuery)({queryKey:["mstAcabados"],queryFn:s.cotizacionesApi.getAcabados}),{data:R}=(0,l.useQuery)({queryKey:["recetasOptions"],queryFn:U.recetasApi.getRecetasOptions}),P=R?.reduce((e,a)=>(e[a.id_modelo]||(e[a.id_modelo]={}),e[a.id_modelo][a.grupo_opcion]||(e[a.id_modelo][a.grupo_opcion]=[]),e[a.id_modelo][a.grupo_opcion].push(a),e),{})||{},[O,q]=(0,i.useState)({id_sistema:"",id_modelo:"",color_perfiles:"",cantidad:1,ancho_mm:1e3,alto_mm:1e3,tipo_vidrio:"",tipo_cierre:"Centro",etiqueta_item:"V-01",ubicacion:"Ambiente",costo_fijo_instalacion:0,opciones_seleccionadas:{}}),[B,M]=(0,i.useState)({descripcion:"",cantidad:1,precio_unitario:0});(0,i.useEffect)(()=>{if(S&&d)if("SERVICIO"===d.id_modelo)A("servicio"),M({descripcion:d.etiqueta_item||"",cantidad:d.cantidad||1,precio_unitario:d._vc_price_unit_oferta_calc||0});else{A("producto");let e=k?.find(e=>e.id_modelo===d.id_modelo);q({id_sistema:e?.id_sistema||"",id_modelo:d.id_modelo||"",color_perfiles:d.color_perfiles||"",cantidad:d.cantidad||1,ancho_mm:d.ancho_mm||1e3,alto_mm:d.alto_mm||1e3,tipo_vidrio:d.tipo_vidrio||"",tipo_cierre:d.tipo_cierre||"Centro",etiqueta_item:d.etiqueta_item||"",ubicacion:d.ubicacion||"",costo_fijo_instalacion:0,opciones_seleccionadas:d.opciones_seleccionadas||{}})}else S&&!d&&(q({id_sistema:"",id_modelo:"",color_perfiles:"",cantidad:1,ancho_mm:1e3,alto_mm:1e3,tipo_vidrio:"",tipo_cierre:"Centro",etiqueta_item:"V-01",ubicacion:"Ambiente",costo_fijo_instalacion:0,opciones_seleccionadas:{}}),M({descripcion:"",cantidad:1,precio_unitario:0}),A("producto"))},[S,d,k]),(0,i.useEffect)(()=>{if(!D||!O.tipo_vidrio)return;let e=D.find(e=>e.id_sku===O.tipo_vidrio);if(e?.es_templado){let a=e.espesor_mm||0,i=15;a>6&&a<=8?i=20:a>8&&(i=25),(O.opciones_seleccionadas.factor_flete!==i.toString()||"true"!==O.opciones_seleccionadas.incluir_flete)&&q(e=>({...e,opciones_seleccionadas:{...e.opciones_seleccionadas,incluir_flete:"true",factor_flete:i.toString()}}))}},[O.tipo_vidrio,D]);let H=O.id_sistema?k?.filter(e=>e.id_sistema===O.id_sistema):k,Q=async a=>{a.preventDefault(),T(!0);try{if("producto"===z){if(!O.id_modelo||!O.color_perfiles){v.warning("Datos incompletos","Complete modelo y color"),T(!1);return}let e=P[O.id_modelo];if(e){for(let[a,i]of Object.entries(e))if(i[0]?.condicion==="BASE"&&!O.opciones_seleccionadas[a]){v.warning("Falta Opción",`Debe seleccionar: ${a}`),T(!1);return}}await t({...O,_isUpdate:!!d})}else{if(!B.descripcion||B.precio_unitario<=0){v.warning("Datos incompletos","Ingrese descripción y precio válido"),T(!1);return}if(d)v.warning("Edición de servicios aún no implementada completamente","Por favor elimine y vuelva a crear si necesita cambiar precios.");else{let a=await s.cotizacionesApi.addLineItem(e,{id_modelo:"SERVICIO",etiqueta_item:B.descripcion,cantidad:B.cantidad,ancho_mm:0,alto_mm:0,color_perfiles:"GEN",tipo_vidrio:null,opciones_seleccionadas:{}});await s.cotizacionesApi.addDesgloseItem({id_linea_cot:a.id_linea_cot,tipo_componente:"Servicio",nombre_componente:B.descripcion,cantidad_calculada:B.cantidad,costo_total_item:B.precio_unitario*B.cantidad,sku_real:"SERV-MANUAL"}),await t({_type:"SERVICE_DONE"})}}d||v.success("Ítem agregado","El ítem se agregó correctamente"),w(!1),M({descripcion:"",cantidad:1,precio_unitario:0})}catch(e){console.error(e),v.error("Error","No se pudo procesar el ítem")}finally{T(!1)}};return(0,a.jsxs)(F.Dialog,{open:S,onOpenChange:w,children:[null!==c&&(0,a.jsx)(F.DialogTrigger,{asChild:!0,children:c||(0,a.jsxs)(o.Button,{className:"w-full sm:w-auto",children:[(0,a.jsx)(u.Plus,{className:"mr-2 h-4 w-4"})," Agregar Ítem"]})}),(0,a.jsxs)(F.DialogContent,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[(0,a.jsxs)(F.DialogHeader,{children:[(0,a.jsx)(F.DialogTitle,{children:d?"Editar Ítem":"Agregar Ítem a Cotización"}),(0,a.jsx)(F.DialogDescription,{children:d?"Modifique los datos del ítem.":"Seleccione el tipo de ítem que desea agregar."})]}),(0,a.jsxs)($.Tabs,{value:z,onValueChange:A,className:"w-full",children:[(0,a.jsxs)($.TabsList,{className:"grid w-full grid-cols-2",children:[(0,a.jsx)($.TabsTrigger,{value:"producto",disabled:!!d&&"SERVICIO"===d.id_modelo,children:"Producto (Ventana/Puerta)"}),(0,a.jsx)($.TabsTrigger,{value:"servicio",disabled:!!d&&"SERVICIO"!==d.id_modelo,children:"Servicio / Extra"})]}),(0,a.jsxs)("form",{onSubmit:Q,children:[(0,a.jsx)($.TabsContent,{value:"producto",className:"space-y-4 py-4",children:(0,a.jsxs)("div",{className:"grid gap-4",children:[(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,a.jsxs)("div",{className:"grid gap-2",children:[(0,a.jsx)(n.Label,{children:"Sistema / Serie *"}),(0,a.jsxs)(m.Select,{value:O.id_sistema,onValueChange:e=>{q({...O,id_sistema:e,id_modelo:""})},children:[(0,a.jsx)(m.SelectTrigger,{children:(0,a.jsx)(m.SelectValue,{placeholder:"Seleccionar Sistema"})}),(0,a.jsx)(m.SelectContent,{children:E?.map(e=>(0,a.jsx)(m.SelectItem,{value:e.id_sistema,children:e.nombre_comercial},e.id_sistema))})]})]}),(0,a.jsxs)("div",{className:"grid gap-2",children:[(0,a.jsx)(n.Label,{children:"Modelo (Receta) *"}),(0,a.jsxs)(m.Select,{value:O.id_modelo,onValueChange:e=>q({...O,id_modelo:e}),disabled:!O.id_sistema,children:[(0,a.jsx)(m.SelectTrigger,{children:(0,a.jsx)(m.SelectValue,{placeholder:O.id_sistema?"Seleccionar Modelo":"Primero seleccione sistema"})}),(0,a.jsx)(m.SelectContent,{children:H?.map(e=>(0,a.jsx)(m.SelectItem,{value:e.id_modelo,children:e.id_modelo},e.id_modelo))})]})]})]}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,a.jsxs)("div",{className:"grid gap-2",children:[(0,a.jsx)(n.Label,{children:"Etiqueta / Nombre"}),(0,a.jsx)(r.Input,{value:O.etiqueta_item,onChange:e=>q({...O,etiqueta_item:e.target.value}),placeholder:"Ej: V-01"})]}),(0,a.jsxs)("div",{className:"grid gap-2",children:[(0,a.jsx)(n.Label,{children:"Ubicación"}),(0,a.jsx)(r.Input,{value:O.ubicacion,onChange:e=>q({...O,ubicacion:e.target.value}),placeholder:"Ej: Dormitorio / Sala"})]})]}),(0,a.jsxs)("div",{className:"grid grid-cols-3 gap-4",children:[(0,a.jsxs)("div",{className:"grid gap-2",children:[(0,a.jsx)(n.Label,{children:"Ancho (mm)"}),(0,a.jsx)(r.Input,{type:"number",value:O.ancho_mm,onChange:e=>q({...O,ancho_mm:Number(e.target.value)})})]}),(0,a.jsxs)("div",{className:"grid gap-2",children:[(0,a.jsx)(n.Label,{children:"Alto (mm)"}),(0,a.jsx)(r.Input,{type:"number",value:O.alto_mm,onChange:e=>q({...O,alto_mm:Number(e.target.value)})})]}),(0,a.jsxs)("div",{className:"grid gap-2",children:[(0,a.jsx)(n.Label,{children:"Cantidad"}),(0,a.jsx)(r.Input,{type:"number",min:1,value:O.cantidad,onChange:e=>q({...O,cantidad:Number(e.target.value)})})]})]}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,a.jsxs)("div",{className:"grid gap-2",children:[(0,a.jsx)(n.Label,{children:"Color Aluminio *"}),(0,a.jsxs)(m.Select,{value:O.color_perfiles,onValueChange:e=>q({...O,color_perfiles:e}),children:[(0,a.jsx)(m.SelectTrigger,{children:(0,a.jsx)(m.SelectValue,{placeholder:"Seleccionar Color"})}),(0,a.jsx)(m.SelectContent,{children:V?.map(e=>(0,a.jsx)(m.SelectItem,{value:e.id_acabado,children:e.nombre_acabado},e.id_acabado))})]})]}),(0,a.jsxs)("div",{className:"grid gap-2",children:[(0,a.jsx)(n.Label,{children:"Tipo Vidrio"}),(0,a.jsxs)(m.Select,{value:O.tipo_vidrio||"SIN_VIDRIO",onValueChange:e=>q({...O,tipo_vidrio:"SIN_VIDRIO"===e?"":e}),children:[(0,a.jsx)(m.SelectTrigger,{children:(0,a.jsx)(m.SelectValue,{placeholder:"Seleccionar Vidrio"})}),(0,a.jsxs)(m.SelectContent,{children:[(0,a.jsx)(m.SelectItem,{value:"SIN_VIDRIO",children:"Sin Vidrio / No Aplica"}),D?.map(e=>(0,a.jsx)(m.SelectItem,{value:e.id_sku,children:e.nombre_completo},e.id_sku))]})]})]})]}),O.id_modelo&&P[O.id_modelo]&&(0,a.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 border-t pt-4",children:Object.entries(P[O.id_modelo]).map(([e,i])=>{let t=i[0]?.condicion==="BASE";return(0,a.jsxs)("div",{className:"grid gap-2",children:[(0,a.jsxs)(n.Label,{children:[e," ",t&&"*"]}),(0,a.jsx)(L.CatalogSkuSelector,{value:O.opciones_seleccionadas[e]||"",onChange:a=>{q(i=>({...i,opciones_seleccionadas:{...i.opciones_seleccionadas,[e]:a}}))},placeholder:`Seleccionar ${e}`}),t&&(0,a.jsx)("p",{className:"text-[10px] text-orange-600 font-medium",children:"Requerido para ingeniería"})]},e)})}),(h=D?.find(e=>e.id_sku===O.tipo_vidrio),g=h?.es_templado||!1,j=h?.espesor_mm||0,_=3,g&&(_=j<=6?15:j<=8?20:25),f="true"===O.opciones_seleccionadas.incluir_flete||g,b=O.opciones_seleccionadas.factor_flete,g&&!b&&O.tipo_vidrio,(0,a.jsxs)("div",{className:"mt-4 p-4 border rounded-lg bg-slate-50 border-slate-200",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,a.jsx)(G.Truck,{className:"h-4 w-4 text-slate-500"}),(0,a.jsx)("h4",{className:"font-semibold text-slate-800 text-sm",children:"Costo Adicional: Embalaje y Flete del cristal"})]}),g&&(0,a.jsxs)("div",{className:"mb-3 p-2 bg-orange-50 border border-orange-200 rounded text-xs text-orange-800",children:[(0,a.jsx)("strong",{children:"Flete Recomendado:"})," El vidrio seleccionado es Templado (",j,"mm). Se recomienda encarecidamente incluir transporte especializado desde planta externa."]}),(0,a.jsxs)("div",{className:"flex flex-col gap-4",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)("input",{type:"checkbox",id:"chk_flete",className:"rounded border-slate-300",checked:f,onChange:e=>{let a=e.target.checked;q(e=>{let i={...e.opciones_seleccionadas};return i.incluir_flete=a?"true":"false",a&&!i.factor_flete?i.factor_flete=_.toString():a||(delete i.factor_flete,delete i.factor_flete_otro),{...e,opciones_seleccionadas:i}})}}),(0,a.jsx)(n.Label,{htmlFor:"chk_flete",className:"font-medium cursor-pointer",children:g?"Incluir Embalaje + Flete Recomendado":"Incluir Embalaje + Flete"})]}),f&&(0,a.jsxs)("div",{className:"grid gap-2 pl-6",children:[(0,a.jsx)(n.Label,{children:"Factor de Peso"}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsxs)(m.Select,{value:["15","20","25"].includes(b)?b:b?"Otro":_.toString(),onValueChange:e=>{q(a=>{let i={...a.opciones_seleccionadas,incluir_flete:"true"};return"Otro"===e?(i.factor_flete="Otro",i.factor_flete_otro="Otro"!==b&&b?b:""):i.factor_flete=e,{...a,opciones_seleccionadas:i}})},children:[(0,a.jsx)(m.SelectTrigger,{className:"w-32",children:(0,a.jsx)(m.SelectValue,{placeholder:"Factor..."})}),(0,a.jsxs)(m.SelectContent,{children:[(0,a.jsx)(m.SelectItem,{value:"15",children:"Factor 15"}),(0,a.jsx)(m.SelectItem,{value:"20",children:"Factor 20"}),(0,a.jsx)(m.SelectItem,{value:"25",children:"Factor 25"}),(0,a.jsx)(m.SelectItem,{value:"Otro",children:"Otro"})]})]}),"Otro"===b&&(0,a.jsx)(r.Input,{type:"number",step:"0.01",min:"0",className:"w-24",placeholder:"Ej: 18",value:O.opciones_seleccionadas.factor_flete_otro||"",onChange:e=>{q(a=>({...a,opciones_seleccionadas:{...a.opciones_seleccionadas,factor_flete_otro:e.target.value}}))}}),(0,a.jsxs)("span",{className:"text-xs text-slate-500",children:["Sugerido para ",g?`Templado ${j}mm`:"Crudo/Laminado",": ",_]})]}),(0,a.jsx)("p",{className:"text-[10px] text-muted-foreground mt-1",children:"Fórmula: Cantidad = Área (m²) × Factor. Costo = Cantidad × Precio Base."})]})]})]}))]})}),(0,a.jsx)($.TabsContent,{value:"servicio",className:"space-y-4 py-4",children:(0,a.jsxs)("div",{className:"p-4 bg-slate-50 rounded border border-slate-200",children:[(0,a.jsx)("p",{className:"text-sm text-slate-600 mb-4",children:"Agregue servicios o ítems extras (instalación específica, accesorios adicionales, etc.) que no requieren cálculo de ingeniería."}),(0,a.jsxs)("div",{className:"grid gap-4",children:[(0,a.jsxs)("div",{className:"grid gap-2",children:[(0,a.jsx)(n.Label,{children:"Descripción del Servicio *"}),(0,a.jsx)(r.Input,{value:B.descripcion,onChange:e=>M({...B,descripcion:e.target.value}),placeholder:"Ej: Instalación de Ventanas 2do Piso"})]}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,a.jsxs)("div",{className:"grid gap-2",children:[(0,a.jsx)(n.Label,{children:"Cantidad"}),(0,a.jsx)(r.Input,{type:"number",min:1,value:B.cantidad,onChange:e=>M({...B,cantidad:Number(e.target.value)})})]}),(0,a.jsxs)("div",{className:"grid gap-2",children:[(0,a.jsx)(n.Label,{children:"Precio Unitario (Costo Directo)"}),(0,a.jsx)(r.Input,{type:"number",step:"0.01",min:0,value:B.precio_unitario,onChange:e=>M({...B,precio_unitario:Number(e.target.value)}),disabled:!!d}),d&&(0,a.jsx)("p",{className:"text-xs text-red-500",children:"Para cambiar precio, elimine y cree de nuevo."}),(0,a.jsx)("p",{className:"text-xs text-muted-foreground",children:"El Markup se aplicará sobre este precio."})]})]})]})]})}),(0,a.jsxs)(F.DialogFooter,{className:"mt-6",children:[(0,a.jsx)(o.Button,{type:"button",variant:"outline",onClick:()=>w(!1),children:"Cancelar"}),(0,a.jsx)(o.Button,{type:"submit",disabled:I,children:I?"Procesando...":d?"Guardar Cambios":"Agregar a Cotización"})]})]})]})]})]})}var W=e.i(41891),J=e.i(38814),Z=e.i(22787),X=e.i(31195),Y=e.i(34239),ee=e.i(59559);function ea({idCotizacion:e,idLineaCot:t,trigger:c}){let[r,n]=(0,i.useState)(!1),[d,m]=(0,i.useState)("resumen"),{data:x,isLoading:u}=(0,l.useQuery)({queryKey:["reporteDesglose",e],queryFn:()=>s.cotizacionesApi.getReporteDesglose(e),enabled:r}),{data:p}=(0,l.useQuery)({queryKey:["cotizacion",e],queryFn:()=>s.cotizacionesApi.getCotizacionById(e),enabled:r}),h=!t,g=(x||[]).filter(e=>!!h||!e.id_linea_cot||!t||e.id_linea_cot===t).map(e=>{let a=e.cantidad_item||1,i=e.cantidad_unitaria||0,t=e.costo_unitario||0,s=0,l=0;return h?(s=i*a,l=t*a):(s=i,l=t),{...e,_displayQty:s,_displayCost:l,_qtyItem:a}}).sort((e,a)=>"Perfil"===e.tipo_componente&&"Perfil"!==a.tipo_componente?-1:+("Perfil"!==e.tipo_componente&&"Perfil"===a.tipo_componente)),j=Object.entries(g.reduce((e,a)=>{let i=a.tipo_componente||"Otros";return e[i]=(e[i]||0)+(a._displayCost||0),e},{})).map(([e,a])=>({name:e,value:a})),_=["#0088FE","#00C49F","#FFBB28","#FF8042","#8884d8"],f=g.reduce((e,a)=>e+(a._displayCost||0),0),v=p?.markup_aplicado??.35;v>1&&(v-=1);let N=f*(1+v),y=(100*v).toFixed(1);return(0,a.jsxs)(F.Dialog,{open:r,onOpenChange:n,children:[(0,a.jsx)(F.DialogTrigger,{asChild:!0,children:c||(0,a.jsxs)(o.Button,{variant:"outline",size:"sm",children:[(0,a.jsx)(b.FileText,{className:"mr-2 h-4 w-4"}),"Ver Despiece ",h?"Global":"Detallado"]})}),(0,a.jsxs)(F.DialogContent,{className:"max-w-[98vw] w-full h-[95vh] flex flex-col p-0 gap-0 sm:max-w-[98vw]",children:[(0,a.jsxs)(F.DialogHeader,{className:"px-6 py-4 border-b",children:[(0,a.jsx)(F.DialogTitle,{children:h?"Desglose Global de Materiales (Proyecto Completo)":"Desglose Unitario de Ingeniería (Por Ítem)"}),(0,a.jsx)(F.DialogDescription,{children:h?"Listado consolidado de materiales para todos los ítems del proyecto.":"Detalle de materiales requeridos para FABRICAR UNA UNIDAD de este ítem."})]}),(0,a.jsx)("div",{className:"flex-1 overflow-hidden p-6",children:(0,a.jsxs)($.Tabs,{defaultValue:"detallado",className:"w-full h-full flex flex-col",children:[(0,a.jsxs)($.TabsList,{className:"mb-4 w-min",children:[(0,a.jsx)($.TabsTrigger,{value:"detallado",children:"Detallado (Tabla)"}),(0,a.jsx)($.TabsTrigger,{value:"resumen",children:"Resumen (Gráfico)"})]}),(0,a.jsxs)($.TabsContent,{value:"detallado",className:"flex-1 overflow-auto border rounded-md relative flex flex-col",children:[(0,a.jsx)("div",{className:"flex-1 overflow-auto",children:(0,a.jsxs)(B.Table,{children:[(0,a.jsx)(B.TableHeader,{className:"sticky top-0 bg-slate-50 z-10 shadow-sm",children:(0,a.jsxs)(B.TableRow,{children:[(0,a.jsx)(B.TableHead,{children:"Tipo"}),(0,a.jsx)(B.TableHead,{children:"SKU / Componente"}),(0,a.jsx)(B.TableHead,{children:"Etiqueta / Ubicación"}),(0,a.jsx)(B.TableHead,{className:"text-right",children:"Medida (mm) / Cant."}),(0,a.jsx)(B.TableHead,{className:"text-right",children:h?"Costo Unitario":"Costo Unit Ref"}),(0,a.jsx)(B.TableHead,{className:"text-right",children:h?"Costo Total Proyecto":"Costo Total"})]})}),(0,a.jsx)(B.TableBody,{children:u?(0,a.jsx)(B.TableRow,{children:(0,a.jsx)(B.TableCell,{colSpan:6,className:"text-center py-8",children:"Cargando..."})}):0===g.length?(0,a.jsx)(B.TableRow,{children:(0,a.jsx)(B.TableCell,{colSpan:6,className:"text-center py-8",children:"No hay datos de ingeniería generados."})}):g.map((e,i)=>(0,a.jsxs)(B.TableRow,{children:[(0,a.jsx)(B.TableCell,{className:"font-medium text-xs",children:e.tipo_componente}),(0,a.jsx)(B.TableCell,{children:(0,a.jsxs)("div",{className:"flex flex-col",children:[(0,a.jsx)("span",{className:"text-sm font-semibold",children:e.nombre_componente}),(0,a.jsx)("span",{className:"text-xs text-muted-foreground",children:e.sku_real})]})}),(0,a.jsx)(B.TableCell,{children:(0,a.jsxs)("div",{className:"flex flex-col text-xs",children:[(0,a.jsx)("span",{children:e.etiqueta_item}),(0,a.jsx)("span",{className:"text-muted-foreground",children:e.ubicacion}),h&&(0,a.jsxs)("span",{className:"text-blue-600 font-bold mt-1",children:["(Cant: ",e._qtyItem,")"]})]})}),(0,a.jsx)(B.TableCell,{className:"text-right text-xs",children:"Perfil"===e.tipo_componente?(0,a.jsxs)(a.Fragment,{children:[Math.round(e.medida_corte_mm)," mm",(0,a.jsxs)("span",{className:"text-muted-foreground ml-1",children:["x ",e._displayQty?.toFixed(2)]})]}):(0,a.jsxs)("span",{children:[e._displayQty?.toFixed(2)," ",e.unidad_medida]})}),(0,a.jsx)(B.TableCell,{className:"text-right font-mono text-xs text-muted-foreground",children:(0,C.formatCurrency)(e.costo_mercado_unit)}),(0,a.jsx)(B.TableCell,{className:"text-right font-bold text-sm",children:(0,C.formatCurrency)(e._displayCost)})]},i))})]})}),(0,a.jsxs)("div",{className:"sticky bottom-0 bg-slate-100 border-t p-4 flex flex-col md:flex-row justify-between items-center z-10 gap-4",children:[(0,a.jsxs)("span",{className:"font-semibold text-sm text-slate-500",children:[g.length," ítems de ingeniería"]}),(0,a.jsxs)("div",{className:"flex items-center gap-8 bg-white p-2 rounded-md border shadow-sm",children:[(0,a.jsxs)("div",{className:"flex flex-col items-end",children:[(0,a.jsxs)("span",{className:"text-[10px] uppercase text-slate-500 font-bold",children:["Costo Directo ",h?"Total":"Unitario"]}),(0,a.jsx)("span",{className:"text-lg font-bold text-slate-700",children:(0,C.formatCurrency)(f)})]}),(0,a.jsx)("div",{className:"h-8 w-px bg-slate-300"}),(0,a.jsxs)("div",{className:"flex flex-col items-end",children:[(0,a.jsxs)("span",{className:"text-[10px] uppercase text-slate-500 font-bold",children:["Markup (",y,"%)"]}),(0,a.jsxs)("span",{className:"text-sm font-mono text-slate-600",children:["x ",(1+v).toFixed(2)]})]}),(0,a.jsx)("div",{className:"h-8 w-px bg-slate-300"}),(0,a.jsxs)("div",{className:"flex flex-col items-end",children:[(0,a.jsxs)("span",{className:"text-[10px] uppercase text-blue-600 font-bold",children:["Precio Venta ",h?"Total":"Unitario"]}),(0,a.jsx)("span",{className:"text-xl font-bold text-blue-700",children:(0,C.formatCurrency)(N)})]})]})]})]}),(0,a.jsx)($.TabsContent,{value:"resumen",className:"flex-1 overflow-auto",children:(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-8 items-center justify-center p-4",children:[(0,a.jsx)("div",{className:"h-[300px] w-full",children:(0,a.jsx)(X.ResponsiveContainer,{width:"100%",height:"100%",children:(0,a.jsxs)(W.PieChart,{children:[(0,a.jsx)(J.Pie,{data:j,cx:"50%",cy:"50%",labelLine:!1,label:({name:e,percent:a})=>`${e} ${(100*a).toFixed(0)}%`,outerRadius:100,fill:"#8884d8",dataKey:"value",children:j.map((e,i)=>(0,a.jsx)(Z.Cell,{fill:_[i%_.length]},`cell-${i}`))}),(0,a.jsx)(Y.Tooltip,{formatter:e=>(0,C.formatCurrency)(Number(e))}),(0,a.jsx)(ee.Legend,{})]})})}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold",children:"Resumen de Costos"}),(0,a.jsxs)("div",{className:"space-y-2",children:[j.map((e,i)=>(0,a.jsxs)("div",{className:"flex justify-between items-center p-2 bg-slate-50 rounded",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("div",{className:"w-3 h-3 rounded-full",style:{backgroundColor:_[i%_.length]}}),(0,a.jsx)("span",{children:e.name})]}),(0,a.jsx)("span",{className:"font-bold",children:(0,C.formatCurrency)(e.value)})]},e.name)),(0,a.jsxs)("div",{className:"flex justify-between items-center p-2 bg-slate-100 rounded border-t border-slate-200 mt-4",children:[(0,a.jsx)("span",{className:"font-bold",children:"Total Costo Directo"}),(0,a.jsx)("span",{className:"font-bold text-lg text-blue-600",children:(0,C.formatCurrency)(j.reduce((e,a)=>e+a.value,0))})]})]})]})]})})]})})]})]})}function ei({id:e}){let S=(0,t.useRouter)(),{toast:w}=(0,q.useToast)(),[I,T]=(0,i.useState)(null),[z,A]=(0,i.useState)(!0),[k,D]=(0,i.useState)([]),[V,F]=(0,i.useState)([]),[R,P]=(0,i.useState)([]),[O,B]=(0,i.useState)([]),[M,$]=(0,i.useState)([]),[G,K]=(0,i.useState)(!1),[W,J]=(0,i.useState)(null),[Z,X]=(0,i.useState)({}),[Y,ee]=(0,i.useState)([]);async function ei(){if(confirm("¿Duplicar esta cotización?"))try{let a=await s.cotizacionesApi.clonarCotizacion(e);w({title:"Éxito",description:"Cotización duplicada correctamente"}),S.push(`/cotizaciones/detalle?id=${a}`)}catch(e){console.error(e),w({variant:"destructive",title:"Error",description:"No se pudo duplicar la cotización"})}}async function et(e){try{await s.cotizacionesApi.clonarItem(e),w({title:"Ítem duplicado",description:"El ítem se ha duplicado correctamente"}),ec()}catch(e){console.error(e),w({variant:"destructive",title:"Error",description:"No se pudo clonar el ítem"})}}async function es(e){if(confirm(`\xbfActualizar ${Y.length} \xedtems?`))try{A(!0),await s.cotizacionesApi.updateLineItems(Y,e),await Promise.all(Y.map(e=>s.cotizacionesApi.triggerDespiece(e))),await new Promise(e=>setTimeout(e,800)),await ec(),ee([]),w({title:"Éxito",description:`${Y.length} \xedtems actualizados correctamente`})}catch(e){console.error(e),w({variant:"destructive",title:"Error",description:"No se pudieron actualizar los ítems"})}finally{A(!1)}}async function el(e){if(confirm("¿Seguro que desea eliminar este ítem?"))try{await s.cotizacionesApi.deleteLineItem(e),w({title:"Eliminado",description:"Ítem eliminado correctamente"}),ec()}catch(e){console.error(e),w({variant:"destructive",title:"Error",description:"No se pudo eliminar el ítem"})}}async function eo(a){try{if("SERVICE_DONE"===a._type)return void ec();if(a._isUpdate&&W)await s.cotizacionesApi.updateLineItems([W.id_linea_cot],{id_modelo:a.id_modelo,color_perfiles:a.color_perfiles,cantidad:a.cantidad,ancho_mm:a.ancho_mm,alto_mm:a.alto_mm,tipo_vidrio:a.tipo_vidrio,etiqueta_item:a.etiqueta_item,ubicacion:a.ubicacion,tipo_cierre:a.tipo_cierre,opciones_seleccionadas:a.opciones_seleccionadas}),await s.cotizacionesApi.triggerDespiece(W.id_linea_cot),await new Promise(e=>setTimeout(e,800)),w({title:"Actualizado",description:"Ítem actualizado correctamente"}),ec();else{let i=await s.cotizacionesApi.addLineItem(e,a);await s.cotizacionesApi.triggerDespiece(i.id_linea_cot),await new Promise(e=>setTimeout(e,800)),w({title:"Agregado",description:"Ítem agregado correctamente"}),ec()}}catch(e){console.error(e),w({variant:"destructive",title:"Error",description:"Error al guardar ítem"})}}async function ec(){A(!0);try{console.log("Cargando datos cotización...",e);let a=null;try{a=await s.cotizacionesApi.getCotizacionById(e)}catch(e){if(console.error("Error fetching cotizacion:",e),"PGRST116"===e.code){w({variant:"destructive",title:"Error",description:"Cotización no encontrada o eliminada"}),S.push("/cotizaciones");return}throw e}T(a),D(a.detalles||[]);try{let e=await s.cotizacionesApi.getClientes();F(e||[])}catch(e){console.error("Error fetching clients:",e)}try{let e=await s.cotizacionesApi.getMarcas();P(e||[])}catch(e){console.error("Error fetching brands:",e)}try{let e=await s.cotizacionesApi.getAcabados();B(e||[])}catch(e){console.error(e)}try{let e=await s.cotizacionesApi.getVidrios();$(e||[])}catch(e){console.error(e)}}catch(e){console.error("Error General Load:",e),w({variant:"destructive",title:"Error",description:`Error cargando cotizaci\xf3n: ${e.message||"Error desconocido"}`})}finally{A(!1)}}async function er(){if(I)try{await s.cotizacionesApi.updateCotizacion(e,{nombre_proyecto:I.nombre_proyecto,id_cliente:I.id_cliente,id_marca:I.id_marca,costo_fijo_instalacion:I.costo_fijo_instalacion||0,costo_mano_obra_m2:I.costo_mano_obra_m2||0,incluye_igv:I.incluye_igv,fecha_prometida:I.fecha_prometida,markup_aplicado:I.markup_aplicado??.35}),k&&k.length>0&&(w({title:"Recalculando...",description:"Actualizando todos los ítems con el nuevo margen"}),await Promise.all(k.map(e=>s.cotizacionesApi.triggerDespiece(e.id_linea_cot))),await new Promise(e=>setTimeout(e,800))),w({title:"Guardado",description:"Los cambios se guardaron correctamente"}),ec()}catch(e){console.error(e),w({variant:"destructive",title:"Error",description:"No se pudieron guardar los cambios"})}}(0,i.useEffect)(()=>{ec(),ec()},[e]);let{data:en}=(0,l.useQuery)({queryKey:["recetasOptions"],queryFn:U.recetasApi.getRecetasOptions}),ed=i.default.useMemo(()=>{if(!en)return{};let e={};return en.forEach(a=>{e[a.id_modelo]||(e[a.id_modelo]={}),e[a.id_modelo][a.grupo_opcion]||(e[a.id_modelo][a.grupo_opcion]=[]),e[a.id_modelo][a.grupo_opcion].push(a)}),e},[en]),em=async(e,a,i)=>{try{let t={...e.opciones_seleccionadas||{},[a]:i};await s.cotizacionesApi.updateLineItems([e.id_linea_cot],{opciones_seleccionadas:t}),w({title:"Opción Actualizada",description:"Se guardó la selección correctamente."}),await s.cotizacionesApi.triggerDespiece(e.id_linea_cot),ec()}catch(e){console.error(e),w({variant:"destructive",title:"Error",description:"No se pudo guardar la opción"})}};async function ex(e){w({title:"Recalculando...",description:"Actualizando ingeniería del ítem."}),await s.cotizacionesApi.triggerDespiece(e),await new Promise(e=>setTimeout(e,800)),await ec(),w({title:"Actualizado",description:"Precios actualizados."})}return z?(0,a.jsx)("div",{children:"Cargando detalle..."}):I?(0,a.jsxs)("div",{className:"flex flex-col gap-4 pb-12",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between border-b pb-4",children:[(0,a.jsxs)("div",{className:"flex items-center gap-4",children:[(0,a.jsx)(o.Button,{variant:"ghost",size:"icon",onClick:()=>S.back(),children:(0,a.jsx)(p.ArrowLeft,{className:"h-5 w-5"})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h2",{className:"text-2xl font-bold",children:I.nombre_proyecto}),(0,a.jsx)("div",{className:"flex gap-2 text-sm text-muted-foreground",children:(0,a.jsx)("span",{children:I.id_cotizacion})})]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsxs)(m.Select,{value:I.estado,onValueChange:async a=>{let i,t=`\xbfCambiar estado a ${a}?`;if("Finalizada"===a&&(t="¿Confirmar ENTREGA FINAL y registrar fecha de hoy?"),confirm(t)){"Rechazada"===a&&(i=prompt("Motivo del rechazo (Opcional):")||void 0);try{await s.cotizacionesApi.updateEstado(e,a,i),w({title:"Estado Actualizado",description:`La cotizaci\xf3n ahora est\xe1 ${a}`}),ec()}catch(e){console.error(e),w({variant:"destructive",title:"Error",description:"No se pudo cambiar el estado"})}}},children:[(0,a.jsx)(m.SelectTrigger,{className:"w-[140px] h-9 bg-background border-input text-foreground font-medium",children:(0,a.jsx)(m.SelectValue,{})}),(0,a.jsxs)(m.SelectContent,{children:[(0,a.jsx)(m.SelectItem,{value:"Borrador",children:"Borrador"}),(0,a.jsx)(m.SelectItem,{value:"Aprobada",children:"Aprobada"}),(0,a.jsx)(m.SelectItem,{value:"Rechazada",children:"Rechazada"}),(0,a.jsx)(m.SelectItem,{value:"Finalizada",children:"Finalizada (Entregada)"}),(0,a.jsx)(m.SelectItem,{value:"Anulada",children:"Anulada"})]})]}),(0,a.jsx)(d.Separator,{orientation:"vertical",className:"h-6 mx-1"}),(0,a.jsxs)(o.Button,{variant:"outline",onClick:ei,children:[(0,a.jsx)(_.Copy,{className:"mr-2 h-4 w-4"})," Duplicar Cotización"]}),(0,a.jsxs)(o.Button,{variant:"outline",onClick:()=>S.push(`/cotizaciones/imprimir?id=${e}`),children:[(0,a.jsx)(h.Printer,{className:"mr-2 h-4 w-4"})," Imprimir"]}),(0,a.jsx)(ea,{idCotizacion:e}),(0,a.jsx)(o.Button,{variant:"outline",onClick:()=>ec(),children:"Refrescar"}),(0,a.jsxs)(o.Button,{onClick:er,children:[(0,a.jsx)(g.Save,{className:"mr-2 h-4 w-4"})," Guardar Cambios"]})]})]}),Y.length>0&&(0,a.jsxs)("div",{className:"bg-muted/50 p-2 rounded-md flex items-center gap-2 animate-in fade-in slide-in-from-top-2 flex-wrap",children:[(0,a.jsxs)("span",{className:"text-sm font-medium ml-2",children:[Y.length," seleccionados"]}),(0,a.jsx)(d.Separator,{orientation:"vertical",className:"h-6"}),(0,a.jsxs)(m.Select,{onValueChange:e=>es({color_perfiles:e}),children:[(0,a.jsx)(m.SelectTrigger,{className:"w-[180px] h-8",children:(0,a.jsx)(m.SelectValue,{placeholder:"Cambiar Color"})}),(0,a.jsx)(m.SelectContent,{children:O.map(e=>(0,a.jsx)(m.SelectItem,{value:e.id_acabado,children:e.nombre_acabado},e.id_acabado))})]}),(0,a.jsxs)(m.Select,{onValueChange:e=>es({tipo_vidrio:e}),children:[(0,a.jsx)(m.SelectTrigger,{className:"w-[200px] h-8",children:(0,a.jsx)(m.SelectValue,{placeholder:"Cambiar Vidrio"})}),(0,a.jsx)(m.SelectContent,{children:M.map(e=>(0,a.jsx)(m.SelectItem,{value:e.id_sku,children:e.nombre_completo},e.id_sku))})]}),(0,a.jsx)(o.Button,{size:"sm",variant:"secondary",onClick:()=>{alert("La MARCA se define a nivel global de la cotización (panel izquierdo).\nNo es posible mezclar marcas en una misma cotización por ahora.")},children:"Cambiar Marca"}),(0,a.jsx)("div",{className:"flex-1"}),(0,a.jsx)(o.Button,{size:"sm",variant:"ghost",onClick:()=>ee([]),children:"Cancelar"})]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[(0,a.jsxs)(c.Card,{className:"md:col-span-1 h-fit",children:[(0,a.jsx)(c.CardHeader,{children:(0,a.jsx)(c.CardTitle,{children:"Información General"})}),(0,a.jsxs)(c.CardContent,{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"grid gap-2",children:[(0,a.jsx)(n.Label,{children:"Nombre del Proyecto"}),(0,a.jsx)(r.Input,{value:I.nombre_proyecto||"",onChange:e=>T({...I,nombre_proyecto:e.target.value})})]}),(0,a.jsxs)("div",{className:"grid gap-2",children:[(0,a.jsx)(n.Label,{children:"Cliente"}),(0,a.jsx)(E,{value:I.id_cliente,onChange:e=>T({...I,id_cliente:e}),clientes:V})]}),(0,a.jsxs)("div",{className:"grid gap-2",children:[(0,a.jsx)(n.Label,{children:"Marca / Sistema"}),(0,a.jsxs)(m.Select,{value:I.id_marca??void 0,onValueChange:e=>T({...I,id_marca:e}),children:[(0,a.jsx)(m.SelectTrigger,{children:(0,a.jsx)(m.SelectValue,{placeholder:"Seleccionar Marca"})}),(0,a.jsx)(m.SelectContent,{children:R.map(e=>(0,a.jsx)(m.SelectItem,{value:e.id_marca,children:e.nombre_marca},e.id_marca))})]})]}),(0,a.jsxs)("div",{className:"grid gap-2",children:[(0,a.jsx)(n.Label,{children:"Fecha Prometida de Entrega"}),(0,a.jsx)(r.Input,{type:"date",value:I.fecha_prometida?new Date(I.fecha_prometida).toISOString().split("T")[0]:"",onChange:e=>T({...I,fecha_prometida:e.target.value?new Date(e.target.value).toISOString():null})})]}),(0,a.jsxs)("div",{className:"grid gap-2",children:[(0,a.jsx)(n.Label,{children:"Costo Mano de Obra (S/ por m²)"}),(0,a.jsx)(r.Input,{type:"number",step:"1",min:0,placeholder:"Ej. 50",value:I.costo_mano_obra_m2??"",onChange:e=>T({...I,costo_mano_obra_m2:Number(e.target.value)||0})}),(0,a.jsx)("p",{className:"text-xs text-muted-foreground",children:"Costo aplicado por metro cuadrado de cada ítem."})]}),(0,a.jsxs)("div",{className:"grid gap-2",children:[(0,a.jsx)(n.Label,{children:"Servicios de Instalación (Opcional)"}),(0,a.jsx)(r.Input,{type:"number",step:"0.01",min:0,placeholder:"Monto fijo para todo el proyecto",value:I.costo_fijo_instalacion??"",onChange:e=>T({...I,costo_fijo_instalacion:Number(e.target.value)||0})}),(0,a.jsx)("p",{className:"text-xs text-muted-foreground",children:"Incluye: Embalaje, Flete, Movilidad, Viáticos"})]}),(0,a.jsx)("div",{className:"flex items-center gap-2 py-2",children:(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)(y.Checkbox,{id:"incluye_igv",checked:I.incluye_igv,onCheckedChange:e=>T({...I,incluye_igv:e})}),(0,a.jsx)(n.Label,{htmlFor:"incluye_igv",children:"Incluye IGV en Precio Final"})]})}),(0,a.jsx)(d.Separator,{}),(0,a.jsxs)("div",{className:"grid gap-2",children:[(0,a.jsx)(n.Label,{children:"Margen de Ganancia (Markup %)"}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(r.Input,{type:"number",step:"0.01",min:"0",value:I.markup_aplicado??0,onChange:e=>T({...I,markup_aplicado:parseFloat(e.target.value)||0})}),(0,a.jsxs)("span",{className:"absolute right-3 top-2 text-muted-foreground text-sm",children:[(100*(I.markup_aplicado||0)).toFixed(0),"%"]})]}),(0,a.jsx)("p",{className:"text-xs text-muted-foreground",children:"Margen aplicado a los costos directos"})]}),(0,a.jsxs)("div",{className:"grid gap-2",children:[(0,a.jsx)(n.Label,{children:"Subtotal (PEN)"}),(0,a.jsx)("div",{className:"text-xl font-mono text-slate-700",children:(0,C.formatCurrency)(I._vc_precio_final_cliente/1.18)})]}),(0,a.jsxs)("div",{className:"grid gap-2",children:[(0,a.jsx)(n.Label,{children:"IGV (18%)"}),(0,a.jsx)("div",{className:"text-xl font-mono text-slate-700",children:(0,C.formatCurrency)(I._vc_precio_final_cliente-I._vc_precio_final_cliente/1.18)})]}),(0,a.jsxs)("div",{className:"grid gap-2",children:[(0,a.jsxs)(n.Label,{children:["Precio Cliente (",I.incluye_igv?"Inc. IGV":"Sin IGV",")"]}),(0,a.jsx)("div",{className:"text-2xl font-bold text-green-600",children:(0,C.formatCurrency)(I._vc_precio_final_cliente)})]})]})]}),(0,a.jsxs)(c.Card,{className:"md:col-span-2 flex flex-col h-auto",children:[(0,a.jsxs)(c.CardHeader,{className:"flex flex-row items-center justify-between py-3",children:[(0,a.jsx)(c.CardTitle,{children:"Ítems de Cotización"}),(0,a.jsxs)(o.Button,{onClick:()=>{J(null),K(!0)},children:[(0,a.jsx)(u.Plus,{className:"mr-2 h-4 w-4"})," Agregar Ítem"]})]}),(0,a.jsx)(c.CardContent,{className:"p-0",children:(0,a.jsxs)("table",{className:"w-full text-sm",children:[(0,a.jsx)("thead",{className:"bg-muted sticky top-0 z-10",children:(0,a.jsxs)("tr",{className:"text-left border-b",children:[(0,a.jsx)("th",{className:"p-3 w-[40px]",children:(0,a.jsx)(y.Checkbox,{checked:Y.length===k.length&&k.length>0,onCheckedChange:e=>{e?ee(k.map(e=>e.id_linea_cot)):ee([])}})}),(0,a.jsx)("th",{className:"p-3",children:"Item"}),(0,a.jsx)("th",{className:"p-3",children:"Medidas"}),(0,a.jsx)("th",{className:"p-3",children:"Cant"}),(0,a.jsx)("th",{className:"p-3 text-right",children:"Unitario"}),(0,a.jsx)("th",{className:"p-3 text-right",children:"Subtotal"}),(0,a.jsx)("th",{className:"p-3 text-center",children:"Acciones"})]})}),(0,a.jsxs)("tbody",{children:[k.map(t=>{let s,l;return(0,a.jsxs)(i.default.Fragment,{children:[(0,a.jsxs)("tr",{className:"border-b hover:bg-muted/50 transition-colors",children:[(0,a.jsx)("td",{className:"p-3",children:(0,a.jsx)(y.Checkbox,{checked:Y.includes(t.id_linea_cot),onCheckedChange:e=>{var a;return a=t.id_linea_cot,void(e?ee(e=>[...e,a]):ee(e=>e.filter(e=>e!==a)))}})}),(0,a.jsx)("td",{className:"p-3",children:(0,a.jsxs)("div",{className:"flex items-start gap-2",children:["SERVICIO"!==t.id_modelo&&(0,a.jsx)(o.Button,{variant:"ghost",size:"icon",className:"h-6 w-6 mt-0.5 shrink-0",onClick:()=>{var e;return e=t.id_linea_cot,void X(a=>({...a,[e]:!a[e]}))},children:Z[t.id_linea_cot]?(0,a.jsx)(N.ChevronDown,{className:"h-4 w-4 text-slate-500"}):(0,a.jsx)(v.ChevronRight,{className:"h-4 w-4 text-slate-500"})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"font-bold",children:t.etiqueta_item}),"SERVICIO"!==t.id_modelo&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"text-xs text-muted-foreground",children:t.id_modelo}),(0,a.jsxs)("div",{className:"text-xs text-muted-foreground",children:["Color: ",t.color_perfiles]}),(s=ed[t.id_modelo||""])?Object.entries(s).map(([e,i])=>{let s=t.opciones_seleccionadas?.[e]||"";return s?(0,a.jsxs)("div",{className:"text-xs text-blue-600 font-medium mt-1",children:[e,": ",(0,a.jsx)("span",{className:"font-mono text-slate-700",children:s})]},e):(0,a.jsxs)("div",{className:"text-xs text-orange-600 font-bold mt-1",children:["⚠️ Falta ",e]},e)}):null]}),"SERVICIO"===t.id_modelo&&(0,a.jsx)("div",{className:"text-xs text-blue-600 font-medium",children:"Servicio / Extra"})]})]})}),(0,a.jsx)("td",{className:"p-3",children:"SERVICIO"===t.id_modelo?"-":`${t.ancho_mm} x ${t.alto_mm}`}),(0,a.jsx)("td",{className:"p-3 text-center font-mono",children:t.cantidad}),(0,a.jsx)("td",{className:"p-3 text-right font-mono text-muted-foreground",children:(0,C.formatCurrency)(t._vc_subtotal_linea_calc/(t.cantidad||1))}),(0,a.jsx)("td",{className:"p-3 text-right font-bold",children:(0,C.formatCurrency)(t._vc_subtotal_linea_calc)}),(0,a.jsxs)("td",{className:"p-3 text-center flex items-center justify-center gap-1",children:["SERVICIO"!==t.id_modelo&&(0,a.jsx)(o.Button,{size:"icon",variant:"ghost",title:"Regenerar Ingeniería",onClick:()=>ex(t.id_linea_cot),children:(0,a.jsx)(j.Calculator,{className:"h-4 w-4"})}),(0,a.jsx)(o.Button,{size:"icon",variant:"ghost",title:"Duplicar Ítem",onClick:()=>et(t.id_linea_cot),children:(0,a.jsx)(_.Copy,{className:"h-4 w-4"})}),(0,a.jsx)(ea,{idCotizacion:e,idLineaCot:t.id_linea_cot,trigger:(0,a.jsx)(o.Button,{size:"icon",variant:"ghost",title:"Ver Despiece",children:(0,a.jsx)(b.FileText,{className:"h-4 w-4 text-blue-600"})})}),(0,a.jsx)(o.Button,{size:"icon",variant:"ghost",title:"Editar Ítem",onClick:()=>{J(t),K(!0)},children:(0,a.jsx)(f.Pencil,{className:"h-4 w-4 text-orange-600"})}),(0,a.jsx)(o.Button,{size:"icon",variant:"ghost",title:"Eliminar Ítem",onClick:()=>el(t.id_linea_cot),children:(0,a.jsx)(x.Trash2,{className:"h-4 w-4 text-red-600"})})]})]}),"SERVICIO"!==t.id_modelo&&Z[t.id_linea_cot]&&(0,a.jsx)("tr",{className:"bg-slate-50 border-b animate-in fade-in zoom-in-95 duration-200",children:(0,a.jsxs)("td",{colSpan:7,className:"p-2 pl-12 text-xs",children:[(l=ed[t.id_modelo||""])?(0,a.jsx)("div",{className:"mb-2 grid grid-cols-2 gap-4 max-w-2xl bg-white p-2 rounded border border-blue-100",children:Object.entries(l).map(([e,i])=>{let s=t.opciones_seleccionadas?.[e]||"";return(0,a.jsxs)("div",{className:"grid gap-1",children:[(0,a.jsx)(n.Label,{className:"text-xs font-semibold text-muted-foreground",children:"TIPO_BRAZO"===e?"Tipo de Brazo":e}),(0,a.jsx)(L.CatalogSkuSelector,{value:s,onChange:a=>em(t,e,a),placeholder:`Seleccionar ${e}`})]},e)})}):null,(0,a.jsx)(H,{idLinea:t.id_linea_cot})]})})]},t.id_linea_cot)}),(I.costo_fijo_instalacion??0)>0&&(0,a.jsxs)("tr",{className:"bg-blue-50/50 border-b border-blue-100",children:[(0,a.jsx)("td",{className:"p-3 text-center text-blue-600 font-mono text-xs",children:"+"}),(0,a.jsxs)("td",{className:"p-3",children:[(0,a.jsx)("div",{className:"font-bold text-blue-800",children:"Servicios de Instalación"}),(0,a.jsx)("div",{className:"text-xs text-blue-600 font-medium",children:"Incluye: Embalaje, Flete, Movilidad, Viáticos, SCTR"})]}),(0,a.jsx)("td",{className:"p-3 text-center text-muted-foreground",children:"-"}),(0,a.jsx)("td",{className:"p-3 text-center font-mono",children:"1"}),(0,a.jsx)("td",{className:"p-3 text-right font-mono text-muted-foreground",children:(0,C.formatCurrency)(I.costo_fijo_instalacion)}),(0,a.jsx)("td",{className:"p-3 text-right font-bold text-blue-800",children:(0,C.formatCurrency)(I.costo_fijo_instalacion)}),(0,a.jsx)("td",{className:"p-3"})]})]})]})})]})]}),(0,a.jsx)(Q,{open:G,onOpenChange:K,idCotizacion:e,itemToEdit:W,onItemAdded:eo,triggerButton:null})]}):(0,a.jsx)("div",{children:"No encontrado"})}e.s(["CotizacionDetail",()=>ei],89198)}]);